apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: default
spec:
  template:
    metadata:
      labels:
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: workload-identity-sa
      restartPolicy: Never
      containers:
      - name: migration
        image: rejdeboer.azurecr.io/multiplayer-db-migration:5df0ca9ee2d70c3add387ed0ee631215a5b066e4
        # volumeMounts:
        #   - name: az-root-certificate
        #     mountPath: /etc/ssl/certs
        #     subPath: az-root.pem
        #     readOnly: true
        env:
          - name: ENVIRONMENT
            value: production
          - name: DB_HOST
            value: multiplayer-server.postgres.database.azure.com
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME
            value: multiplayer-server
          - name: DB_USERNAME
            value: multiplayer-server-aks
          # - name: DB_USER
          #   valueFrom:
          #     secretKeyRef:
          #       name: multiplayer-server-secrets
          #       key: postgres-username
          # - name: DB_PASSWORD
          #   valueFrom:
          #     secretKeyRef:
          #       name: multiplayer-server-secrets
          #       key: postgres-password
      volumes:
        - name: az-root-certificate
          configMap:
            name: az-root-certificate
